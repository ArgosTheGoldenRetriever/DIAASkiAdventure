<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DIAA - AI Ski Adventure</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #87CEEB;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* Prevents scrolling completely */
            touch-action: none; /* Disables double-tap zoom */
            overscroll-behavior: none;
        }
        
        #gameCanvas {
            background: white;
            /* Responsive Logic */
            width: 100%;
            max-width: 800px; /* Max width for desktop */
            height: auto;
            max-height: 100vh;
            object-fit: contain; /* Keeps aspect ratio intact */
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }
        
        /* Stats Bar - Floating at top */
        #info {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            text-align: center;
            z-index: 10;
        }
        
        .stats {
            font-size: 16px;
            font-weight: bold;
            margin: 0 10px;
            display: inline-block;
        }
        
        .controls-text {
            font-size: 12px; 
            color: #666;
            margin-top: 5px;
            display: none; /* Hide text instructions on mobile */
        }

        /* Show text instructions only on Desktop */
        @media (min-width: 900px) {
            .controls-text { display: block; }
            #gameCanvas { border: 4px solid #333; }
        }
        
        /* Game Over Modal */
        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
            width: 85%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 100;
        }
        
        #gameOver h1 { color: #ff4444; margin: 0 0 15px 0; }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            margin: 5px;
        }

        /* --- MOBILE CONTROLS --- */
        #mobileControls {
            display: none; /* Hidden on Desktop */
            position: fixed; /* Floats above everything */
            bottom: 30px;
            left: 0;
            width: 100%;
            padding: 0 20px;
            box-sizing: border-box;
            justify-content: space-between;
            z-index: 50; 
            pointer-events: none; /* Allows touching the game through the empty space */
        }

        /* Only show on screens smaller than 900px */
        @media (max-width: 900px) {
            #mobileControls { display: flex; }
        }

        .d-pad, .action-btns {
            display: flex;
            gap: 15px;
            pointer-events: auto; /* Re-enable touch for the buttons */
        }

        /* Base style for all control buttons */
        .control-btn {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5); /* Semi-transparent */
            border: 2px solid #333;
            font-size: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-user-select: none;
            backdrop-filter: blur(4px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* --- THE FIX: Make D-Pad buttons wider --- */
        .d-pad .control-btn {
            width: 110px; /* Significantly wider than height */
        }

        .control-btn:active {
            background: rgba(76, 175, 80, 0.8);
            transform: scale(0.9);
        }

        /* Leaderboard Button */
        #leaderboardBtn {
            position: absolute;
            top: 60px; /* Pushed down so it doesn't cover stats */
            right: 10px;
            background: #2196F3;
            padding: 8px 15px;
            font-size: 12px;
            z-index: 40;
            opacity: 0.9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Leaderboard Styles */
        #nameEntry input {
            padding: 10px;
            font-size: 16px;
            border: 2px solid #4CAF50;
            border-radius: 5px;
            width: 70%;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }
        
        .leaderboard-entry {
            padding: 8px;
            margin: 5px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            text-align: left;
        }
        
        .leaderboard-entry.current-score {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
        }

        .rank { color: #FFD700; font-weight: bold; margin-right: 10px; }
        .score { color: #4CAF50; font-weight: bold; }
    </style>
</head>
<body>

    <button id="leaderboardBtn" onclick="showLeaderboardModal()">üèÜ Top 10</button>
    
    <div id="info">
        <div class="stats">Dist: <span id="distance">0</span>m</div>
        <div class="stats">Speed: <span id="speed">0</span></div>
        <div class="controls-text">
            Arrow Keys to move | F for Boost | R to Restart
        </div>
    </div>

    <canvas id="gameCanvas" width="800" height="600"></canvas>
    
    <div id="mobileControls">
        <div class="d-pad">
            <div class="control-btn" id="btnLeft">‚¨ÖÔ∏è</div>
            <div class="control-btn" id="btnRight">‚û°Ô∏è</div>
        </div>
        <div class="action-btns">
            <div class="control-btn" id="btnBoost" style="background: rgba(255, 215, 0, 0.5);">‚ö°</div>
            <div class="control-btn" id="btnRestart" style="background: rgba(255, 99, 71, 0.5);">üîÑ</div>
        </div>
    </div>
    
    <div id="gameOver">
        <h1>GAME OVER</h1>
        <p id="finalScore"></p>
        
        <div id="nameEntry" style="display:none;">
            <p style="color: #FFD700; font-weight: bold;">üéâ TOP 10! Enter name:</p>
            <input type="text" id="playerName" maxlength="15" placeholder="Your Name">
            <button onclick="submitScore()">Submit</button>
        </div>
        
        <div id="leaderboard">
            <h2>üèÜ LEADERBOARD üèÜ</h2>
            <div id="leaderboardList">
                <p id="loadingMsg">Loading...</p>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <button onclick="restartGame()">Play Again</button>
            <button onclick="closeModal()" style="background:#666;">Close</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCvDmozbYu61rtepx7ihL52g4OtfP38Kf8",
            authDomain: "diaa-ski-adventure.firebaseapp.com",
            databaseURL: "https://diaa-ski-adventure-default-rtdb.firebaseio.com",
            projectId: "diaa-ski-adventure",
            storageBucket: "diaa-ski-adventure.firebasestorage.app",
            messagingSenderId: "506212603635",
            appId: "1:506212603635:web:1c6e8e7f8343c247fe0986",
            measurementId: "G-NY1JX13GP3"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const leaderboardRef = database.ref('leaderboard');

        // Game Setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let gameRunning = true;
        let distance = 0;
        let speed = 5;
        let baseSpeed = 5;
        let timeRemaining = 60;
        let lastTime = Date.now();
        let currentScores = [];
        let finalDistance = 0;
        
        // Entities
        const skier = { x: canvas.width / 2, y: 150, width: 20, height: 30, direction: 0, crashed: false };
        let obstacles = [];
        const obstacleTypes = ['tree', 'rock', 'stump', 'text', 'text', 'text'];
        const obstacleTexts = ['Hallucinations', 'Jailbreaks', 'Bias', 'Overfit', 'Prompt Injection', 'Mode Collapse', 'Adversarial', 'Toxic Output'];
        let snowTexts = [];
        let bonusItems = [];
        const bonusLabels = ['Apollo', 'LGI', 'aiRIS', 'Maverick', 'Trident'];
        let yeti = { active: false, x: -100, y: -100, width: 40, height: 50, speed: 0 };
        const keys = {};
        
        // --- LEADERBOARD LOGIC ---
        function loadLeaderboard(callback) {
            leaderboardRef.orderByChild('score').limitToLast(10).once('value', (snapshot) => {
                currentScores = [];
                snapshot.forEach((childSnapshot) => {
                    currentScores.push({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                currentScores.sort((a, b) => b.score - a.score);
                if (callback) callback();
            });
        }

        function displayLeaderboard(highlightScore = null) {
            const leaderboardList = document.getElementById('leaderboardList');
            if (currentScores.length === 0) {
                leaderboardList.innerHTML = '<p style="color: #888;">No scores yet.</p>';
                return;
            }
            let html = '';
            currentScores.forEach((entry, index) => {
                const isCurrentScore = highlightScore !== null && Math.abs(entry.score - highlightScore) < 1;
                const entryClass = isCurrentScore ? 'leaderboard-entry current-score' : 'leaderboard-entry';
                html += `<div class="${entryClass}"><span class="rank">#${index + 1}</span><span class="player-name">${entry.name}</span><span class="score">${entry.score}m</span></div>`;
            });
            leaderboardList.innerHTML = html;
        }

        function isTopTen(score) {
            if (currentScores.length < 10) return true;
            return score > currentScores[currentScores.length - 1].score;
        }

        function submitScore() {
            const nameInput = document.getElementById('playerName');
            const playerName = nameInput.value.trim();
            if (!playerName) { alert('Enter name!'); return; }
            const newScore = { name: playerName, score: finalDistance, timestamp: Date.now() };
            leaderboardRef.push(newScore).then(() => {
                loadLeaderboard(() => {
                    displayLeaderboard(finalDistance);
                    document.getElementById('nameEntry').style.display = 'none';
                });
            });
        }

        function showLeaderboardModal() {
            loadLeaderboard(() => {
                displayLeaderboard();
                document.getElementById('gameOver').style.display = 'block';
                document.getElementById('finalScore').style.display = 'none';
                document.getElementById('nameEntry').style.display = 'none';
            });
        }

        function closeModal() {
            document.getElementById('gameOver').style.display = 'none';
        }

        // --- GAME INITIALIZATION ---
        function initObstacles() {
            obstacles = [];
            for (let i = 0; i < 50; i++) obstacles.push(createObstacle(i * 100 + Math.random() * 200));
        }
        function createObstacle(yPosition) {
            const type = obstacleTypes[Math.floor(Math.random() * obstacleTypes.length)];
            const obstacle = { x: Math.random() * (canvas.width - 40) + 20, y: yPosition, type: type, width: 30, height: 30 };
            if (type === 'text') { obstacle.label = obstacleTexts[Math.floor(Math.random() * obstacleTexts.length)]; obstacle.width = 80; }
            return obstacle;
        }
        function initSnowTexts() {
            snowTexts = [];
            for (let i = 0; i < 10; i++) snowTexts.push(createSnowText(i * 300 + Math.random() * 200));
        }
        function createSnowText(yPosition) { return { x: Math.random() * (canvas.width - 200) + 100, y: yPosition, rotation: (Math.random() - 0.5) * 0.3 }; }
        function initBonusItems() {
            bonusItems = [];
            for (let i = 0; i < 15; i++) bonusItems.push(createBonusItem(i * 200 + Math.random() * 150));
        }
        function createBonusItem(yPosition) {
            return { x: Math.random() * (canvas.width - 80) + 40, y: yPosition, label: bonusLabels[Math.floor(Math.random() * bonusLabels.length)], radius: 25, collected: false };
        }
        
        // --- DRAWING ---
        function drawSkier() {
            ctx.save();
            ctx.translate(skier.x, skier.y);
            if (skier.crashed) {
                ctx.strokeStyle = '#ff0000'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(-10, -10); ctx.lineTo(10, 10); ctx.moveTo(10, -10); ctx.lineTo(-10, 10); ctx.stroke();
            } else {
                ctx.fillStyle = '#ff0000'; ctx.fillRect(-5, -15, 10, 20);
                ctx.fillStyle = '#ffdbac'; ctx.beginPath(); ctx.arc(0, -20, 6, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#333'; ctx.fillRect(-8, 5, 4, 20); ctx.fillRect(4, 5, 4, 20);
                ctx.strokeStyle = '#333'; ctx.lineWidth = 2;
                if (skier.direction === -1) ctx.rotate(-0.3);
                else if (skier.direction === 1) ctx.rotate(0.3);
                ctx.beginPath(); ctx.moveTo(-10, 0); ctx.lineTo(-12, 15); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(10, 0); ctx.lineTo(12, 15); ctx.stroke();
            }
            ctx.restore();
        }
        
        function drawObstacle(obs) {
            if (obs.type === 'text') { ctx.font = 'bold 12px Courier New'; ctx.textAlign = 'center'; ctx.fillStyle = '#ff0000'; ctx.fillText(obs.label, obs.x, obs.y); }
            else if (obs.type === 'tree') { ctx.fillStyle = '#8B4513'; ctx.fillRect(obs.x - 5, obs.y, 10, 15); ctx.fillStyle = '#228B22'; ctx.beginPath(); ctx.moveTo(obs.x, obs.y - 15); ctx.lineTo(obs.x - 15, obs.y); ctx.lineTo(obs.x + 15, obs.y); ctx.fill(); }
            else if (obs.type === 'rock') { ctx.fillStyle = '#696969'; ctx.beginPath(); ctx.arc(obs.x, obs.y, 12, 0, Math.PI * 2); ctx.fill(); }
            else { ctx.fillStyle = '#8B4513'; ctx.fillRect(obs.x - 8, obs.y - 8, 16, 16); }
        }

        function drawYeti() {
            ctx.save(); ctx.translate(yeti.x, yeti.y); ctx.fillStyle = '#808080'; ctx.fillRect(-20, -25, 40, 40); ctx.fillStyle = '#000000'; ctx.beginPath(); ctx.arc(-5, -35, 3, 0, Math.PI * 2); ctx.fill(); ctx.beginPath(); ctx.arc(5, -35, 3, 0, Math.PI * 2); ctx.fill(); ctx.restore();
        }
        
        function drawSnowText(text) { ctx.save(); ctx.translate(text.x, text.y); ctx.rotate(text.rotation); ctx.font = '48px Courier New'; ctx.textAlign = 'center'; ctx.fillStyle = 'rgba(200, 200, 200, 0.3)'; ctx.fillText('DIAA', 0, 0); ctx.restore(); }
        
        function drawBonusItem(bonus) {
            if (bonus.collected) return;
            ctx.save(); ctx.translate(bonus.x, bonus.y); ctx.strokeStyle = '#32CD32'; ctx.lineWidth = 3; ctx.beginPath(); ctx.arc(0, 0, bonus.radius, 0, Math.PI * 2); ctx.stroke(); ctx.fillStyle = 'rgba(50, 205, 50, 0.3)'; ctx.fill(); ctx.font = 'bold 10px Courier New'; ctx.textAlign = 'center'; ctx.fillStyle = '#228B22'; ctx.fillText(bonus.label, 0, 4); ctx.restore();
        }

        // --- UPDATES ---
        function updateTimer() {
            const now = Date.now(); const deltaTime = (now - lastTime) / 1000; lastTime = now;
            timeRemaining -= deltaTime;
            if (timeRemaining <= 0) { timeRemaining = 0; if (!skier.crashed) { skier.crashed = true; gameOver('Time\'s up!'); } }
        }

        function updateSkier() {
            if (skier.crashed) return;
            if (keys['ArrowLeft'] || keys['a'] || keys['A']) { skier.direction = -1; skier.x -= 5; speed = baseSpeed * 0.7; }
            else if (keys['ArrowRight'] || keys['d'] || keys['D']) { skier.direction = 1; skier.x += 5; speed = baseSpeed * 0.7; }
            else { skier.direction = 0; speed = baseSpeed; }
            if (keys['f'] || keys['F']) { speed = baseSpeed * 2; }
            skier.x = Math.max(20, Math.min(canvas.width - 20, skier.x));
            distance += speed * 0.1;
            if (distance > 200) baseSpeed = Math.min(5 + (distance - 200) / 100, 15);
        }

        function updateObstacles() {
            obstacles.forEach(obs => obs.y -= speed);
            obstacles = obstacles.filter(obs => obs.y > -50);
            while (obstacles.length < 50) { let lastY = obstacles.length > 0 ? Math.max(...obstacles.map(o => o.y)) : 0; obstacles.push(createObstacle(lastY + 100 + Math.random() * 200)); }
        }
        function updateSnowTexts() {
            snowTexts.forEach(text => text.y -= speed);
            snowTexts = snowTexts.filter(text => text.y > -50);
            while (snowTexts.length < 10) { let lastY = snowTexts.length > 0 ? Math.max(...snowTexts.map(t => t.y)) : 0; snowTexts.push(createSnowText(lastY + 300 + Math.random() * 200)); }
        }
        function updateBonusItems() {
            bonusItems.forEach(bonus => bonus.y -= speed);
            bonusItems = bonusItems.filter(bonus => bonus.y > -50);
            while (bonusItems.length < 15) { let lastY = bonusItems.length > 0 ? Math.max(...bonusItems.map(b => b.y)) : 0; bonusItems.push(createBonusItem(lastY + 200 + Math.random() * 150)); }
        }
        
        function updateYeti() {
            if (distance > 500 && !yeti.active && !skier.crashed) { yeti.active = true; yeti.x = skier.x - 100; yeti.y = canvas.height + 50; yeti.speed = speed + 2; }
            if (yeti.active) {
                if (yeti.x < skier.x) yeti.x += 3; if (yeti.x > skier.x) yeti.x -= 3;
                yeti.y -= yeti.speed; yeti.speed = Math.min(yeti.speed + 0.05, speed + 4);
                if (Math.abs(yeti.x - skier.x) < 30 && Math.abs(yeti.y - skier.y) < 40) { skier.crashed = true; gameOver('The Yeti got you!'); }
            }
        }
        
        function checkCollisions() {
            if (skier.crashed) return;
            obstacles.forEach(obs => {
                let collisionWidth = obs.type === 'text' ? 40 : 25;
                if (Math.abs(obs.y - skier.y) < 30 && Math.abs(obs.x - skier.x) < collisionWidth) { skier.crashed = true; gameOver('You crashed!'); }
            });
            bonusItems.forEach(bonus => {
                if (!bonus.collected && Math.sqrt(Math.pow(bonus.x - skier.x, 2) + Math.pow(bonus.y - skier.y, 2)) < bonus.radius + 15) {
                    bonus.collected = true; distance += 100; showBonusText(bonus);
                }
            });
        }
        
        function showBonusText(bonus) {
            const bonusText = { x: bonus.x, y: bonus.y, text: '+100m', startTime: Date.now() };
            const animateBonus = () => {
                const elapsed = Date.now() - bonusText.startTime;
                if (elapsed < 1000) {
                    ctx.save(); ctx.font = 'bold 20px Courier New'; ctx.textAlign = 'center';
                    ctx.fillStyle = `rgba(50, 205, 50, ${1 - elapsed/1000})`;
                    ctx.fillText(bonusText.text, bonusText.x, bonusText.y - elapsed * 0.05); ctx.restore();
                    requestAnimationFrame(animateBonus);
                }
            };
            animateBonus();
        }

        function gameOver(reason) {
            gameRunning = false; finalDistance = Math.floor(distance);
            document.getElementById('gameOver').style.display = 'block'; document.getElementById('finalScore').style.display = 'block';
            let message = `You traveled ${finalDistance}m! ${reason}`;
            document.getElementById('finalScore').textContent = message;
            loadLeaderboard(() => {
                displayLeaderboard();
                if (isTopTen(finalDistance)) { document.getElementById('nameEntry').style.display = 'block'; document.getElementById('playerName').value = ''; }
                else { document.getElementById('nameEntry').style.display = 'none'; }
            });
        }
        
        function restartGame() {
            gameRunning = true; distance = 0; speed = 5; baseSpeed = 5; timeRemaining = 60; lastTime = Date.now();
            skier.x = canvas.width / 2; skier.y = 150; skier.crashed = false; skier.direction = 0;
            yeti.active = false;
            initObstacles(); initSnowTexts(); initBonusItems();
            document.getElementById('gameOver').style.display = 'none';
            gameLoop();
        }
        
        function gameLoop() {
            if (!gameRunning) return;
            updateTimer(); updateSkier(); updateObstacles(); updateSnowTexts(); updateBonusItems(); updateYeti(); checkCollisions();
            
            // Update UI
            document.getElementById('distance').textContent = Math.floor(distance);
            document.getElementById('speed').textContent = Math.floor(speed);
            
            // Draw
            ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            snowTexts.forEach(t => { if(t.y > -50 && t.y < 650) drawSnowText(t); });
            bonusItems.forEach(b => { if(b.y > -50 && b.y < 650) drawBonusItem(b); });
            obstacles.forEach(o => { if(o.y > -30 && o.y < 630) drawObstacle(o); });
            drawSkier();
            if (yeti.active) drawYeti();
            
            ctx.save(); ctx.font = 'bold 32px Courier New'; ctx.textAlign = 'center'; ctx.fillStyle = timeRemaining <= 10 ? '#ff0000' : '#000000'; ctx.fillText(`Time: ${Math.ceil(timeRemaining)}s`, canvas.width / 2, 40); ctx.restore();
            
            if (yeti.active && !skier.crashed && yeti.y > canvas.height - 100) { ctx.fillStyle = 'rgba(255, 0, 0, 0.8)'; ctx.font = 'bold 24px Courier New'; ctx.textAlign = 'center'; ctx.fillText('THE YETI IS COMING!', canvas.width / 2, 80); }
            
            requestAnimationFrame(gameLoop);
        }

        // --- INPUT HANDLING (KEYBOARD & TOUCH) ---
        
        // Keyboard
        document.addEventListener('keydown', (e) => {
            const isTyping = document.activeElement.tagName === 'INPUT';
            if (!isTyping) {
                keys[e.key] = true;
                if (e.key === 'r' || e.key === 'R') restartGame();
            }
            if ((e.key === 'Enter') && document.getElementById('nameEntry').style.display !== 'none' && isTyping) submitScore();
        });
        document.addEventListener('keyup', (e) => { if (document.activeElement.tagName !== 'INPUT') keys[e.key] = false; });

        // Touch (Helper Function)
        function setupTouch(elemId, keyMap) {
            const elem = document.getElementById(elemId);
            if(!elem) return;
            
            // Touch Start: Trigger Key Down
            elem.addEventListener('touchstart', (e) => {
                e.preventDefault(); // Stop browser zooming/scrolling
                keys[keyMap] = true;
                if(keyMap === 'r') restartGame();
            }, {passive: false});

            // Touch End: Trigger Key Up
            elem.addEventListener('touchend', (e) => {
                e.preventDefault();
                keys[keyMap] = false;
            }, {passive: false});
        }

        // Map Buttons to Keys
        setupTouch('btnLeft', 'ArrowLeft');
        setupTouch('btnRight', 'ArrowRight');
        setupTouch('btnBoost', 'f');
        setupTouch('btnRestart', 'r');

        // Start
        initObstacles(); initSnowTexts(); initBonusItems(); gameLoop();
    </script>
</body>
</html>
